#!/bin/bash

repository_name() {
    echo bashlibs-repository
}

repository_dir() {
    create_dir_if_needed \
        $(progdir)/../debian/$(repository_name)/$(repository_architecture)
}

repository_binary_dir() {
    create_dir_if_needed \
        $(repository_dir)/binary
}

run_remote() {
    ssh root@$(host) -- $@
}

target_architecture() {
    run_remote "uname -i"
}

repository_architecture() {
    local arch=$(target_architecture)

    case $arch in
        armv7l) echo armhf ;;
          i686) echo i386  ;;
          i386) echo i386  ;;
    esac
}

deb_archive_dir() {
    create_dir_if_needed \
        $(progdir)/../debian/deb-archive/$(repository_architecture)
}

copy_deb_to_repository() {
    local debfile=$1

    rsync -a \
        $debfile \
        $(repository_binary_dir)
}

uniq_packages() {
    local dir=$1

    ls $dir/*deb \
        | sort \
        | uniq
}

newest_package() {
    local package_prefix=$1

    ls -t1 ${package_prefix}* \
        | head -1
}

copy_newest_debs_to_repository() {
    local i

    for i in $(uniq_packages $(deb_archive_dir))
    do
        copy_deb_to_repository \
            $(newest_package $i)
    done
}

create_repository() {
    copy_newest_debs_to_repository
    $(progdir)/debrepos $(repository_dir)
}
