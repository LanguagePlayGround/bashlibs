#!/bin/bash

repository_name() {
    echo bashlibs-repository
}

repository_dir() {
    create_dir_if_needed \
        $(progdir)/../debian/$(repository_name)
}

repository_binary_dir() {
    create_dir_if_needed \
        $(repository_dir)/binary
}

deb_archive_dir() {
    create_dir_if_needed \
        $(progdir)/../debian/deb-archive
}

copy_deb_to_repository() {
    local debfile=$1

    rsync -a \
        $debfile \
        $(repository_binary_dir)
}

uniq_packages() {
    local dir=$1

    ls $dir/*deb \
        | sort \
        | uniq
}

newest_package() {
    local package_prefix=$1

    ls -t1 ${package_prefix}* \
        | head -1
}

copy_newest_debs_to_repository() {
    local i

    for i in $(uniq_packages $(deb_archive_dir))
    do
        copy_deb_to_repository \
            $(newest_package $i)
    done
}

create_repository() {
    copy_newest_debs_to_repository
    $(progdir)/debrepos $(repository_dir)
}
